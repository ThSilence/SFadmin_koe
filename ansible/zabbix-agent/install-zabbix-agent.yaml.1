---
- hosts: all
  tasks:
          - apt_repository:
        repo: https://repo.zabbix.com/zabbix/6.5/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.5-1+ubuntu20.04_all.deb
        dpkg_chek: yes
        when:
                ansible_os_family == "Debian"
        become: yes 
          - name: dowloand repo RedHat
            become: yes
            command: rpm -Uvh https://repo.zabbix.com/zabbix/6.4/rhel/7/x86_64/zabbix-release-6.4-1.el7.noarch.rpm
            when:
                   ansible_os_family == "RedHat" 
      - name: Install zabbix agent RedHat
        become: yes
        yum:
            name: zabbix-agent
            state: latest
        when:
                ansible_os_family == "RedHat"
       - name: Install Zabbix-agent Ubuntu
         become: yes
         apt:
                 name: zabbix-agent
                 state: latest
          when:
                  ansible_os_family == "Debian"

      - name: Stop service zabbix-agent
        become: yes
        service:
            name: zabbix-agent
            state: stopped

      - name: Remove zabbix config file
        become: yes
        file:
            path: /etc/zabbix/zabbix_agentd.conf
            state: absent

      - name: Create new zabbix config file from template
        become: yes
        template:
            src: "templates/zabbix_agentd.conf.j2"
            dest: "/etc/zabbix/zabbix_agentd.conf"

      - name: Start service zabbix-agent
        become: yes
        service:
            name: zabbix-agent
            state: started
